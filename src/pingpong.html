<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ä¹’ä¹“çƒå°æˆ°éŠæˆ²</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        font-family: "Arial", sans-serif;
      }

      .game-container {
        text-align: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        backdrop-filter: blur(10px);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: white;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      canvas {
        background: #000;
        border: 3px solid #fff;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        transform: translateZ(0);
        will-change: transform;
      }

      .score {
        color: white;
        font-size: 24px;
        margin: 20px 0;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
      }

      .controls {
        color: white;
        margin-top: 15px;
        font-size: 14px;
      }

      .game-over {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      }

      .game-over-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 40px;
        border-radius: 20px;
        text-align: center;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 3px solid rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(10px);
        max-width: 400px;
        animation: gameOverSlideIn 0.5s ease-out;
      }

      .game-over-title {
        color: #ffff00;
        font-size: 32px;
        font-weight: bold;
        margin-bottom: 20px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
      }

      .game-over-buttons {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 20px;
      }

      @keyframes gameOverSlideIn {
        from {
          opacity: 0;
          transform: scale(0.8) translateY(-50px);
        }
        to {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      button {
        background: linear-gradient(45deg, #ff6b6b, #ee5a24);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 16px;
        margin: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .fps-counter {
        position: absolute;
        top: 10px;
        left: 10px;
        color: #00ff00;
        font-size: 12px;
        background: rgba(0, 0, 0, 0.7);
        padding: 5px;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <h1>ğŸ“ ä¹’ä¹“çƒå°æˆ°éŠæˆ²</h1>
      <div class="score">
        ç©å®¶ï¼š
        <span id="playerScore">0</span>
        ï½œé›»è…¦ï¼š
        <span id="computerScore">0</span>
      </div>
      <div class="controls" style="margin-bottom: 15px">
        <label style="color: white; margin-right: 10px; font-size: 14px"
          >é›£åº¦ï¼š</label
        >
        <label style="color: white; margin-right: 10px">
          <input
            type="radio"
            name="difficulty"
            value="1"
            style="margin-right: 3px"
          />
          1
        </label>
        <label style="color: white; margin-right: 10px">
          <input
            type="radio"
            name="difficulty"
            value="2"
            style="margin-right: 3px"
          />
          2
        </label>
        <label style="color: white; margin-right: 10px">
          <input
            type="radio"
            name="difficulty"
            value="3"
            checked
            style="margin-right: 3px"
          />
          3
        </label>
        <label style="color: white; margin-right: 10px">
          <input
            type="radio"
            name="difficulty"
            value="4"
            style="margin-right: 3px"
          />
          4
        </label>
        <label style="color: white">
          <input
            type="radio"
            name="difficulty"
            value="5"
            style="margin-right: 3px"
          />
          5
        </label>
        <label style="color: white; margin-right: 10px">
          <input
            type="radio"
            name="difficulty"
            value="6"
            style="margin-right: 3px"
          />
          6
        </label>
        <label style="color: white; margin-right: 10px">
          <input
            type="radio"
            name="difficulty"
            value="7"
            style="margin-right: 3px"
          />
          7
        </label>
        <label style="color: white">
          <input
            type="radio"
            name="difficulty"
            value="8"
            style="margin-right: 3px"
          />
          8
        </label>
      </div>
      <div style="position: relative">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <div
          id="fpsCounter"
          style="
            position: absolute;
            top: 10px;
            left: 10px;
            color: #00ff00;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px;
            border-radius: 3px;
            z-index: 10;
          "
        >
          FPS: 60
        </div>
      </div>
      <div class="controls">
        ä½¿ç”¨ â† â†’ æ–¹å‘éµæ§åˆ¶ä½ çš„æ©«æ¡¿ç§»å‹•
        <br />
        æŒ‰
        <strong>ç©ºç™½éµ</strong>
        ç™¼çƒæˆ–åœ¨çƒæ¥è¿‘æ™‚åŠ é€Ÿ
        <br />
      </div>
      <div
        id="servingStatus"
        class="controls"
        style="
          color: #ffff00;
          font-size: 16px;
          font-weight: bold;
          height: 25px;
          line-height: 25px;
        "
      ></div>
      <div
        id="boostStatus"
        class="controls"
        style="
          color: #ff6b6b;
          font-size: 14px;
          font-weight: bold;
          height: 20px;
          line-height: 20px;
        "
      ></div>
      <div id="gameStatus" class="game-over" style="display: none">
        <div class="game-over-content">
          <div id="gameStatusTitle" class="game-over-title"></div>
          <div class="game-over-buttons">
            <button id="restartBtn" onclick="restartGame()">é‡æ–°é–‹å§‹</button>
            <button onclick="window.location.href='index.html'">
              ğŸ  è¿”å›éŠæˆ²é¸å–®
            </button>
          </div>
        </div>
      </div>
      <button
        onclick="window.location.href='index.html'"
        style="margin-top: 10px"
      >
        ğŸ  è¿”å›éŠæˆ²é¸å–®
      </button>
    </div>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const playerScoreElement = document.getElementById("playerScore");
      const computerScoreElement = document.getElementById("computerScore");
      const gameStatusElement = document.getElementById("gameStatus");
      const gameStatusTitleElement = document.getElementById("gameStatusTitle");
      const servingStatusElement = document.getElementById("servingStatus");
      const boostStatusElement = document.getElementById("boostStatus");
      const fpsCounterElement = document.getElementById("fpsCounter");
      const restartBtn = document.getElementById("restartBtn");

      // éŠæˆ²ç‹€æ…‹
      let gameRunning = true;
      let playerScore = 0;
      let computerScore = 0;
      let waitingForServe = true;
      let serverIsPlayer = true; // true = ç©å®¶ç™¼çƒ, false = é›»è…¦ç™¼çƒ
      let gamePaused = false; // éŠæˆ²æ˜¯å¦æš«åœï¼ˆå¾—åˆ†å¾Œï¼‰
      let canStartNextRound = false; // æ˜¯å¦å¯ä»¥é–‹å§‹ä¸‹ä¸€å±€
      let pauseStartTime = 0; // æš«åœé–‹å§‹æ™‚é–“
      let ballBoosted = false; // çƒæ˜¯å¦è¢«åŠ é€Ÿ
      let boostMultiplier = 1.8; // åŠ é€Ÿå€æ•¸ï¼ˆ1.8å€ï¼‰
      let boostByPlayer = false; // è¿½è¹¤æ˜¯èª°åŠ é€Ÿäº†çƒï¼ˆtrue=ç©å®¶ï¼Œfalse=é›»è…¦ï¼‰
      let difficultyMode = "easy"; // é›£åº¦æ¨¡å¼
      let boostParticles = []; // åŠ é€Ÿç²’å­æ•ˆæœ

      // æ©«æ¡¿æ“Šçƒå‹•ç•«ç›¸é—œè®Šæ•¸
      let playerPaddleAnimating = false; // ç©å®¶æ©«æ¡¿æ˜¯å¦æ­£åœ¨å‹•ç•«
      let computerPaddleAnimating = false; // é›»è…¦æ©«æ¡¿æ˜¯å¦æ­£åœ¨å‹•ç•«
      let playerPaddleOriginalY = 0; // ç©å®¶æ©«æ¡¿åŸå§‹Yä½ç½®
      let computerPaddleOriginalY = 0; // é›»è…¦æ©«æ¡¿åŸå§‹Yä½ç½®
      let paddleAnimationProgress = 0; // å‹•ç•«é€²åº¦ (0-1)
      const PADDLE_ANIMATION_SPEED = 0.15; // å‹•ç•«é€Ÿåº¦
      const PADDLE_ANIMATION_DISTANCE = 15; // ç§»å‹•è·é›¢

      // å›ºå®šæ™‚é–“æ­¥é•·æ§åˆ¶
      let lastTime = 0;
      let accumulator = 0;
      const FIXED_TIMESTEP = 1000 / 60; // 60fps = 16.67ms per frame
      const MAX_FRAME_TIME = 1000 / 30; // æœ€å¤§å¹€æ™‚é–“ï¼Œé˜²æ­¢èºæ—‹æ­»äº¡

      // FPSè¨ˆç®—
      let frameCount = 0;
      let fpsTime = 0;
      let currentFPS = 60;

      // ç©å®¶æ©«æ¡¿ (åº•éƒ¨)
      const player = {
        x: canvas.width / 2 - 60,
        y: canvas.height - 20,
        width: 120,
        height: 15,
        speed: 6 * (FIXED_TIMESTEP / 1000) * 60, // è½‰æ›ç‚ºæ¯ç§’åƒç´ 
        color: "#00ff00",
      };

      // é›»è…¦æ©«æ¡¿ (é ‚éƒ¨)
      const computer = {
        x: canvas.width / 2 - 60,
        y: 5,
        width: 120,
        height: 15,
        speed: 3 * (FIXED_TIMESTEP / 1000) * 60,
        color: "#ff0040",
      };

      // å„²å­˜æ©«æ¡¿åŸå§‹Yä½ç½®
      playerPaddleOriginalY = player.y;
      computerPaddleOriginalY = computer.y;

      // çƒ
      const ball = {
        x: canvas.width / 2,
        y: canvas.height - 40, // åˆå§‹ä½ç½®åœ¨ç©å®¶æ©«æ¡¿é™„è¿‘
        radius: 10,
        speedX: 0,
        speedY: 0,
        color: "#ffffff",
      };

      // æŒ‰éµç‹€æ…‹
      const keys = {
        left: false,
        right: false,
      };

      // ç²å–é›£åº¦è¨­å®š
      function getDifficulty() {
        const radios = document.querySelectorAll('input[name="difficulty"]');
        for (let radio of radios) {
          if (radio.checked) {
            return parseInt(radio.value);
          }
        }
        return 3; // é è¨­é›£åº¦3
      }

      // ç¦ç”¨/å•Ÿç”¨é›£åº¦é¸æ“‡
      function setDifficultyEnabled(enabled) {
        const radios = document.querySelectorAll('input[name="difficulty"]');
        radios.forEach((radio) => {
          radio.disabled = !enabled;
        });
      }

      // æ ¹æ“šé›£åº¦ç²å–é›»è…¦è¨­å®š
      function getComputerSettings(difficulty) {
        const settings = {
          1: { speed: 3, boostChance: 0, offsetChance: 0, maxOffsetPercent: 0 },
          2: {
            speed: 4,
            boostChance: 0,
            offsetChance: 0.2,
            maxOffsetPercent: 0.3,
          },
          3: {
            speed: 5,
            boostChance: 0.1,
            offsetChance: 0.3,
            maxOffsetPercent: 0.5,
          },
          4: {
            speed: 6,
            boostChance: 0.2,
            offsetChance: 0.4,
            maxOffsetPercent: 0.6,
          },
          5: {
            speed: 6,
            boostChance: 0.3,
            offsetChance: 0.5,
            maxOffsetPercent: 0.7,
          },
          6: {
            speed: 6,
            boostChance: 0.4,
            offsetChance: 0.6,
            maxOffsetPercent: 0.8,
          },
          7: {
            speed: 7,
            boostChance: 0.6,
            offsetChance: 0.7,
            maxOffsetPercent: 0.9,
          },
          8: {
            speed: 8,
            boostChance: 0.8,
            offsetChance: 0.8,
            maxOffsetPercent: 1,
          },
        };
        return settings[difficulty] || settings[3];
      }

      // æª¢æŸ¥æ˜¯å¦å¯ä»¥åŠ é€Ÿ
      function canBoost() {
        if (!gameRunning) return false;

        // æª¢æŸ¥çƒæ˜¯å¦æ¥è¿‘ç©å®¶æ©«æ¡¿
        const distanceToPlayer = Math.abs(ball.y - player.y);
        const ballMovingToPlayer = ball.speedY > 0;

        return ballMovingToPlayer && distanceToPlayer < 30;
      }

      // å•Ÿå‹•ç©å®¶æ©«æ¡¿å‹•ç•«
      function startPlayerPaddleAnimation() {
        if (!playerPaddleAnimating) {
          playerPaddleAnimating = true;
          paddleAnimationProgress = 0;
        }
      }

      // å•Ÿå‹•é›»è…¦æ©«æ¡¿å‹•ç•«
      function startComputerPaddleAnimation() {
        if (!computerPaddleAnimating) {
          computerPaddleAnimating = true;
          paddleAnimationProgress = 0;
        }
      }

      // æ›´æ–°æ©«æ¡¿å‹•ç•«
      function updatePaddleAnimations() {
        if (playerPaddleAnimating || computerPaddleAnimating) {
          paddleAnimationProgress += PADDLE_ANIMATION_SPEED;

          if (paddleAnimationProgress >= 1) {
            // å‹•ç•«çµæŸï¼Œæ¢å¾©åŸå§‹ä½ç½®
            paddleAnimationProgress = 0;
            playerPaddleAnimating = false;
            computerPaddleAnimating = false;
            player.y = playerPaddleOriginalY;
            computer.y = computerPaddleOriginalY;
          } else {
            // è¨ˆç®—å‹•ç•«ä½ç½®
            // ä½¿ç”¨ sin å‡½æ•¸è£½é€ å¹³æ»‘çš„ä¾†å›å‹•ç•«
            const animationOffset =
              Math.sin(paddleAnimationProgress * Math.PI) *
              PADDLE_ANIMATION_DISTANCE;

            if (playerPaddleAnimating) {
              // ç©å®¶æ©«æ¡¿å¾€ä¸Šç§»å‹•ï¼ˆè² æ–¹å‘ï¼‰
              player.y = playerPaddleOriginalY - animationOffset;
            }

            if (computerPaddleAnimating) {
              // é›»è…¦æ©«æ¡¿å¾€ä¸‹ç§»å‹•ï¼ˆæ­£æ–¹å‘ï¼‰
              computer.y = computerPaddleOriginalY + animationOffset;
            }
          }
        }
      }

      // å‰µå»ºåŠ é€Ÿç²’å­æ•ˆæœ
      function createBoostParticles(x, y) {
        for (let i = 0; i < 15; i++) {
          boostParticles.push({
            x: x + (Math.random() - 0.5) * 30,
            y: y + (Math.random() - 0.5) * 30,
            vx: (Math.random() - 0.5) * 8,
            vy: (Math.random() - 0.5) * 8,
            life: 30,
            maxLife: 30,
            color: `hsl(${Math.random() * 60 + 320}, 100%, ${
              50 + Math.random() * 30
            }%)`,
          });
        }
      }

      // æ›´æ–°å’Œç¹ªè£½ç²’å­æ•ˆæœ
      function updateAndDrawParticles() {
        boostParticles = boostParticles.filter((particle) => {
          particle.x += particle.vx;
          particle.y += particle.vy;
          particle.vx *= 0.95;
          particle.vy *= 0.95;
          particle.life--;

          const alpha = particle.life / particle.maxLife;
          ctx.globalAlpha = alpha;
          ctx.fillStyle = particle.color;
          ctx.beginPath();
          ctx.arc(particle.x, particle.y, 2 + alpha * 2, 0, Math.PI * 2);
          ctx.fill();

          return particle.life > 0;
        });
        ctx.globalAlpha = 1;
      }

      // ç©å®¶åŠ é€Ÿçƒ
      function boostBall() {
        if (!canBoost()) return false;

        ballBoosted = true;
        boostByPlayer = true; // ç©å®¶åŠ é€Ÿ

        // è¨ˆç®—ç•¶å‰é€Ÿåº¦å¤§å°
        const currentSpeed = Math.sqrt(
          ball.speedX * ball.speedX + ball.speedY * ball.speedY
        );
        const boostedSpeed = currentSpeed * boostMultiplier;

        // è¨ˆç®—æå‰æ“Šçƒçš„åå½ˆè§’åº¦ï¼ˆæ¨¡æ“¬ç¢°åˆ°æ©«æ¡¿çš„æ•ˆæœï¼‰
        const paddleCenterX = player.x + player.width / 2;
        const relativeHitX = ball.x - paddleCenterX;
        const normalizedHit = Math.max(
          -1,
          Math.min(1, relativeHitX / (player.width / 2))
        ); // é™åˆ¶åœ¨-1åˆ°1ä¹‹é–“

        // æ ¹æ“šåŠæ©¢åœ“å½¢ç‹€è¨ˆç®—åå½ˆè§’åº¦
        const bounceAngle = (normalizedHit * Math.PI) / 3; // æœ€å¤§60åº¦è§’

        // ç«‹å³æ”¹è®Šçƒçš„æ–¹å‘å’Œé€Ÿåº¦ï¼ˆå‘ä¸Šå½ˆï¼‰
        ball.speedX = Math.sin(bounceAngle) * boostedSpeed;
        ball.speedY = -Math.cos(bounceAngle) * boostedSpeed; // ç¢ºä¿å‘ä¸Šå½ˆ

        // å‰µå»ºç²’å­æ•ˆæœ
        createBoostParticles(ball.x, ball.y);

        boostStatusElement.textContent = "âš¡ ä½ æå‰æ“ŠçƒåŠ é€Ÿï¼";
        setTimeout(() => {
          if (boostStatusElement.textContent === "âš¡ ä½ æå‰æ“ŠçƒåŠ é€Ÿï¼") {
            boostStatusElement.textContent = "";
          }
        }, 1500);

        return true;
      }

      // éµç›¤äº‹ä»¶ç›£è½
      document.addEventListener("keydown", (e) => {
        switch (e.key) {
          case "ArrowLeft":
            keys.left = true;
            e.preventDefault();
            break;
          case "ArrowRight":
            keys.right = true;
            e.preventDefault();
            break;
          case " ":
            if (waitingForServe && serverIsPlayer && gameRunning) {
              serveBall();
            } else if (gamePaused && canStartNextRound) {
              // é–‹å§‹ä¸‹ä¸€å±€
              startNextRound();
            } else if (!playerPaddleAnimating) {
              // åªæœ‰åœ¨æ²’æœ‰å‹•ç•«é€²è¡Œæ™‚æ‰èƒ½æ“Šçƒ
              startPlayerPaddleAnimation();
              if (canBoost()) {
                boostBall();
              }
            }
            e.preventDefault();
            break;
        }
      });

      document.addEventListener("keyup", (e) => {
        switch (e.key) {
          case "ArrowLeft":
            keys.left = false;
            break;
          case "ArrowRight":
            keys.right = false;
            break;
        }
      });

      // ç¹ªè£½æ©«æ¡¿
      function drawPaddle(paddle) {
        const centerX = paddle.x + paddle.width / 2;
        const centerY = paddle.y + paddle.height / 2;
        const radiusX = paddle.width / 2;
        const radiusY = paddle.height;

        ctx.fillStyle = paddle.color;
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;

        // ç¹ªè£½åŠæ©¢åœ“å½¢æ©«æ¡¿
        ctx.beginPath();

        if (paddle === player) {
          // ç©å®¶æ©«æ¡¿ï¼ˆåº•éƒ¨ï¼‰- ä¸ŠåŠéƒ¨ç‚ºå¼§å½¢
          ctx.ellipse(
            centerX,
            paddle.y + paddle.height,
            radiusX,
            radiusY,
            0,
            Math.PI,
            0
          );
          ctx.lineTo(paddle.x, paddle.y + paddle.height);
          ctx.closePath();
        } else {
          // é›»è…¦æ©«æ¡¿ï¼ˆé ‚éƒ¨ï¼‰- ä¸‹åŠéƒ¨ç‚ºå¼§å½¢
          ctx.ellipse(centerX, paddle.y, radiusX, radiusY, 0, 0, Math.PI);
          ctx.lineTo(paddle.x, paddle.y);
          ctx.closePath();
        }

        ctx.fill();
        ctx.stroke();
      }

      // ç¹ªè£½çƒ
      function drawBall() {
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);

        if (ballBoosted) {
          // åŠ é€Ÿçƒè®Šæˆäº®æ©™è‰²
          ctx.fillStyle = "#ff8c00"; // äº®æ©™è‰²
          ctx.shadowColor = "#ff8c00";
          ctx.shadowBlur = 15;
        } else {
          // æ™®é€šçƒæ˜¯ç™½è‰²
          ctx.fillStyle = ball.color;
          ctx.shadowColor = ball.color;
          ctx.shadowBlur = 10;
        }

        ctx.fill();
        ctx.shadowBlur = 0;
      }

      // æ›´æ–°ç©å®¶æ©«æ¡¿ä½ç½®
      function updatePlayer() {
        if (keys.left && player.x > 0) {
          player.x -= player.speed;
        }
        if (keys.right && player.x < canvas.width - player.width) {
          player.x += player.speed;
        }
      }

      // é›»è…¦æœŸæœ›æ“Šçƒé»ç›¸é—œè®Šæ•¸
      let computerTargetHitPoint = null; // é›»è…¦çš„æœŸæœ›æ“Šçƒé»ï¼ˆç›¸å°æ–¼æ©«æ¡¿ä¸­å¿ƒçš„åç§»ï¼‰
      let computerInDefensePhase = false; // æ˜¯å¦è™•æ–¼é˜²å®ˆéšæ®µï¼ˆç©å®¶æ“Šçƒåˆ°é›»è…¦æ“Šçƒï¼‰

      // æ›´æ–°é›»è…¦æ©«æ¡¿ä½ç½® (AI)
      function updateComputer() {
        const difficulty = getDifficulty();
        const computerSettings = getComputerSettings(difficulty);

        // è½‰æ›é€Ÿåº¦ç‚ºæ¯å¹€åƒç´ 
        computer.speed = computerSettings.speed * (FIXED_TIMESTEP / 1000) * 60;

        const paddleCenter = computer.x + computer.width / 2;
        const ballCenter = ball.x;

        // åˆ¤æ–·ç•¶å‰éšæ®µï¼šçƒæ˜¯å¦æ­£æœé›»è…¦ç§»å‹•
        const ballMovingToComputer = ball.speedY < 0; // è² æ•¸è¡¨ç¤ºå¾€ä¸Šç§»å‹•ï¼ˆæœé›»è…¦ï¼‰
        const ballMovingToPlayer = ball.speedY > 0; // æ­£æ•¸è¡¨ç¤ºå¾€ä¸‹ç§»å‹•ï¼ˆæœç©å®¶ï¼‰

        // éšæ®µ1ï¼šé›»è…¦å‰›æ“Šçƒï¼Œçƒæœç©å®¶ç§»å‹• - é‡ç½®æœŸæœ›æ“Šçƒé»ï¼Œç”¨ä¸­å¿ƒé»è¿½çƒ
        if (ballMovingToPlayer && computerInDefensePhase) {
          computerInDefensePhase = false;
          computerTargetHitPoint = null; // é‡ç½®æœŸæœ›æ“Šçƒé»
        }

        // éšæ®µ2ï¼šç©å®¶æ“Šçƒï¼Œçƒæœé›»è…¦ç§»å‹• - è¨­å®šæœŸæœ›æ“Šçƒé»ä¸¦ä¿æŒ
        if (ballMovingToComputer && !computerInDefensePhase) {
          computerInDefensePhase = true;

          // æ ¹æ“šé›£åº¦æ±ºå®šæ˜¯å¦åé›¢ä¸­å¿ƒé»
          computerTargetHitPoint = 0; // é è¨­ä½¿ç”¨ä¸­å¿ƒé»

          if (difficulty >= 2) {
            // åé›¢ä¸­å¿ƒé»çš„æ©Ÿç‡éš¨é›£åº¦å¢åŠ 
            if (Math.random() < computerSettings.offsetChance) {
              // æ±ºå®šåç§»æ–¹å‘å’Œå¹…åº¦
              const maxOffset = Math.min(
                (computerSettings.maxOffsetPercent * computer.width) / 2,
                computer.width / 2 - 1
              ); // æœ€å¤§åç§»é‡

              if (difficulty >= 7) {
                // é«˜é›£åº¦ï¼šæˆ°è¡“æ€§åç§» - å„ªå…ˆé¸æ“‡é é›¢ç©å®¶çš„ä¸€å´
                const playerCenter = player.x + player.width / 2;
                const ballToPlayerDistance = Math.abs(
                  ballCenter - playerCenter
                );

                if (ballToPlayerDistance > 20) {
                  // åªæœ‰ç•¶çƒé›¢ç©å®¶ä¸­å¿ƒè¼ƒé æ™‚æ‰ä½¿ç”¨æˆ°è¡“
                  if (ballCenter > playerCenter) {
                    // çƒåœ¨ç©å®¶å³å´ï¼Œé›»è…¦ç”¨å³é‚Šæ“Šçƒ
                    computerTargetHitPoint =
                      Math.random() * maxOffset * 0.8 + maxOffset * 0.2;
                  } else {
                    // çƒåœ¨ç©å®¶å·¦å´ï¼Œé›»è…¦ç”¨å·¦é‚Šæ“Šçƒ
                    computerTargetHitPoint = -(
                      Math.random() * maxOffset * 0.8 +
                      maxOffset * 0.2
                    );
                  }
                } else {
                  // éš¨æ©Ÿåç§»
                  computerTargetHitPoint =
                    (Math.random() - 0.5) * 2 * maxOffset;
                }
              } else {
                // ä¸­ä½é›£åº¦ï¼šéš¨æ©Ÿåç§»
                computerTargetHitPoint = (Math.random() - 0.5) * 2 * maxOffset;
              }

              // ç¢ºä¿åç§»ä¸æœƒè®“é›»è…¦æ©«æ¡¿è¶…å‡ºç•«é¢
              const futureHitX = ballCenter + computerTargetHitPoint;
              const paddleHalfWidth = computer.width / 2;

              if (futureHitX - paddleHalfWidth < 0) {
                computerTargetHitPoint = paddleHalfWidth - ballCenter;
              } else if (futureHitX + paddleHalfWidth > canvas.width) {
                computerTargetHitPoint =
                  canvas.width - paddleHalfWidth - ballCenter;
              }
            }
          }
        }

        // è¨ˆç®—ç›®æ¨™ä½ç½®
        let targetX;
        if (computerInDefensePhase && computerTargetHitPoint !== null) {
          // é˜²å®ˆéšæ®µï¼šä½¿ç”¨æœŸæœ›æ“Šçƒé»
          targetX = ballCenter + computerTargetHitPoint;
        } else {
          // éé˜²å®ˆéšæ®µï¼šä½¿ç”¨æ©«æ¡¿ä¸­å¿ƒè¿½çƒ
          targetX = ballCenter;
        }

        // ç§»å‹•é›»è…¦æ©«æ¡¿
        const tolerance = difficulty >= 4 ? 3 : 8; // é«˜é›£åº¦æ›´ç²¾ç¢º

        if (
          paddleCenter < targetX - tolerance &&
          computer.x < canvas.width - computer.width
        ) {
          computer.x += computer.speed;
        } else if (paddleCenter > targetX + tolerance && computer.x > 0) {
          computer.x -= computer.speed;
        }

        // é›»è…¦AIåŠ é€Ÿé‚è¼¯
        if (
          computerSettings.boostChance > 0 &&
          !ballBoosted &&
          !waitingForServe
        ) {
          const distanceToComputer = Math.abs(
            ball.y - (computer.y + computer.height)
          );
          const ballMovingToComputer = ball.speedY < 0;

          if (ballMovingToComputer && distanceToComputer < 30) {
            if (Math.random() < computerSettings.boostChance) {
              ballBoosted = true;
              boostByPlayer = false;

              const currentSpeed = Math.sqrt(
                ball.speedX * ball.speedX + ball.speedY * ball.speedY
              );
              const boostedSpeed = currentSpeed * boostMultiplier;

              const paddleCenterX = computer.x + computer.width / 2;
              const relativeHitX = ball.x - paddleCenterX;
              const normalizedHit = Math.max(
                -1,
                Math.min(1, relativeHitX / (computer.width / 2))
              );
              const bounceAngle = (normalizedHit * Math.PI) / 3;

              ball.speedX = Math.sin(bounceAngle) * boostedSpeed;
              ball.speedY = Math.cos(bounceAngle) * boostedSpeed;

              createBoostParticles(ball.x, ball.y);
              startComputerPaddleAnimation(); // å•Ÿå‹•é›»è…¦æ©«æ¡¿å‹•ç•«
              boostStatusElement.textContent = `ğŸ¤– é›»è…¦æå‰æ“ŠçƒåŠ é€Ÿï¼(é›£åº¦${difficulty})`;
              setTimeout(() => {
                if (
                  boostStatusElement.textContent.includes(
                    "ğŸ¤– é›»è…¦æå‰æ“ŠçƒåŠ é€Ÿï¼"
                  )
                ) {
                  boostStatusElement.textContent = "";
                }
              }, 1500);
            }
          }
        }
      }

      // ç™¼çƒå‡½æ•¸
      function serveBall() {
        waitingForServe = false;

        // ç¬¬ä¸€æ¬¡ç™¼çƒæ™‚ç¦ç”¨é›£åº¦é¸æ“‡
        if (playerScore === 0 && computerScore === 0) {
          setDifficultyEnabled(false);
        }

        if (serverIsPlayer) {
          // ç©å®¶ç™¼çƒ
          ball.x = player.x + player.width / 2;
          ball.y = player.y - ball.radius - 5;
          ball.speedX = (Math.random() - 0.5) * 4; // éš¨æ©Ÿå·¦å³è§’åº¦
          ball.speedY = -5; // å‘ä¸Šç™¼çƒ
        } else {
          // é›»è…¦ç™¼çƒ
          ball.x = computer.x + computer.width / 2;
          ball.y = computer.y + computer.height + ball.radius + 5;
          ball.speedX = (Math.random() - 0.5) * 4; // éš¨æ©Ÿå·¦å³è§’åº¦
          ball.speedY = 5; // å‘ä¸‹ç™¼çƒ
        }

        updateServingStatus();
      }

      // æ›´æ–°ç™¼çƒç‹€æ…‹é¡¯ç¤º
      function updateServingStatus() {
        if (waitingForServe && gameRunning) {
          if (serverIsPlayer) {
            servingStatusElement.textContent = "ğŸ“ è¼ªåˆ°ä½ ç™¼çƒï¼æŒ‰ç©ºç™½éµç™¼çƒ";
          } else {
            servingStatusElement.textContent = "ğŸ¤– é›»è…¦æº–å‚™ç™¼çƒ...";
            // é›»è…¦è‡ªå‹•ç™¼çƒï¼ˆå»¶é²1ç§’ï¼‰
            setTimeout(() => {
              if (waitingForServe && !serverIsPlayer) {
                serveBall();
              }
            }, 1000);
          }
        } else {
          servingStatusElement.textContent = "";
        }
      }

      // æ›´æ–°çƒçš„ä½ç½®
      function updateBall() {
        if (waitingForServe) {
          // ç™¼çƒæº–å‚™éšæ®µï¼Œçƒè·Ÿè‘—ç™¼çƒæ–¹æ©«æ¡¿ç§»å‹•
          if (serverIsPlayer) {
            ball.x = player.x + player.width / 2;
            ball.y = player.y - ball.radius - 5;
          } else {
            ball.x = computer.x + computer.width / 2;
            ball.y = computer.y + computer.height + ball.radius + 5;
          }
          return;
        }

        ball.x += ball.speedX;
        ball.y += ball.speedY;

        // å·¦å³é‚Šç•Œç¢°æ’
        if (ball.x <= ball.radius) {
          ball.x = ball.radius; // ç¢ºä¿çƒä¸æœƒè¶…å‡ºå·¦é‚Šç•Œ
          ball.speedX = Math.abs(ball.speedX); // ç¢ºä¿å‘å³å½ˆ
        } else if (ball.x >= canvas.width - ball.radius) {
          ball.x = canvas.width - ball.radius; // ç¢ºä¿çƒä¸æœƒè¶…å‡ºå³é‚Šç•Œ
          ball.speedX = -Math.abs(ball.speedX); // ç¢ºä¿å‘å·¦å½ˆ
        }

        // èˆ‡æ©«æ¡¿ç¢°æ’æª¢æ¸¬
        // ç©å®¶æ©«æ¡¿ç¢°æ’ï¼ˆåŠæ©¢åœ“å½¢ï¼‰
        if (
          ball.y + ball.radius >= player.y &&
          ball.y - ball.radius <= player.y + player.height &&
          ball.x >= player.x &&
          ball.x <= player.x + player.width
        ) {
          // è¨ˆç®—ç¢°æ’é»ç›¸å°æ–¼æ©«æ¡¿ä¸­å¿ƒçš„ä½ç½®
          const paddleCenterX = player.x + player.width / 2;
          const relativeHitX = ball.x - paddleCenterX;
          const normalizedHit = relativeHitX / (player.width / 2); // -1 åˆ° 1

          // æ ¹æ“šåŠæ©¢åœ“å½¢ç‹€è¨ˆç®—åå½ˆè§’åº¦
          const bounceAngle = (normalizedHit * Math.PI) / 3; // æœ€å¤§60åº¦è§’
          const speed = Math.sqrt(
            ball.speedX * ball.speedX + ball.speedY * ball.speedY
          );

          ball.speedX = Math.sin(bounceAngle) * speed;
          ball.speedY = -Math.cos(bounceAngle) * speed; // ç¢ºä¿å‘ä¸Šå½ˆ

          // åªæœ‰ç•¶çƒæ˜¯é›»è…¦åŠ é€Ÿçš„æ™‚å€™ï¼Œç©å®¶ç¢°åˆ°æ‰æ¢å¾©é€Ÿåº¦
          if (ballBoosted && !boostByPlayer) {
            // è¨ˆç®—ç•¶å‰é€Ÿåº¦ä¸¦æ¢å¾©åˆ°æ­£å¸¸é€Ÿåº¦
            const currentSpeed = Math.sqrt(
              ball.speedX * ball.speedX + ball.speedY * ball.speedY
            );
            const normalSpeed = currentSpeed / boostMultiplier;

            // é‡æ–°è¨ˆç®—åå½ˆå¾Œçš„æ­£å¸¸é€Ÿåº¦
            ball.speedX = Math.sin(bounceAngle) * normalSpeed;
            ball.speedY = -Math.cos(bounceAngle) * normalSpeed;

            ballBoosted = false;
            boostStatusElement.textContent = "âœ… ä½ æˆåŠŸæ¥ä½äº†åŠ é€Ÿçƒï¼";
            setTimeout(() => {
              if (
                boostStatusElement.textContent === "âœ… ä½ æˆåŠŸæ¥ä½äº†åŠ é€Ÿçƒï¼"
              ) {
                boostStatusElement.textContent = "";
              }
            }, 1000);
          } else if (ballBoosted && boostByPlayer) {
            // å¦‚æœæ˜¯ç©å®¶è‡ªå·±åŠ é€Ÿçš„çƒï¼Œæ­£å¸¸åå½ˆä½†ä¿æŒåŠ é€Ÿç‹€æ…‹
            // çƒå·²ç¶“è¢«åŠ é€Ÿéäº†ï¼Œé€™æ¬¡ç¢°æ’ä¸æ”¹è®ŠåŠ é€Ÿç‹€æ…‹
          }
        }

        // é›»è…¦æ©«æ¡¿ç¢°æ’ï¼ˆåŠæ©¢åœ“å½¢ï¼‰
        if (
          ball.y - ball.radius <= computer.y + computer.height &&
          ball.y + ball.radius >= computer.y &&
          ball.x >= computer.x &&
          ball.x <= computer.x + computer.width
        ) {
          // è¨ˆç®—ç¢°æ’é»ç›¸å°æ–¼æ©«æ¡¿ä¸­å¿ƒçš„ä½ç½®
          const paddleCenterX = computer.x + computer.width / 2;
          const relativeHitX = ball.x - paddleCenterX;
          const normalizedHit = relativeHitX / (computer.width / 2); // -1 åˆ° 1

          // æ ¹æ“šåŠæ©¢åœ“å½¢ç‹€è¨ˆç®—åå½ˆè§’åº¦
          const bounceAngle = (normalizedHit * Math.PI) / 3; // æœ€å¤§60åº¦è§’
          const speed = Math.sqrt(
            ball.speedX * ball.speedX + ball.speedY * ball.speedY
          );

          ball.speedX = Math.sin(bounceAngle) * speed;
          ball.speedY = Math.cos(bounceAngle) * speed; // ç¢ºä¿å‘ä¸‹å½ˆ

          // åªæœ‰ç•¶çƒæ˜¯ç©å®¶åŠ é€Ÿçš„æ™‚å€™ï¼Œé›»è…¦ç¢°åˆ°æ‰æ¢å¾©é€Ÿåº¦
          if (ballBoosted && boostByPlayer) {
            // è¨ˆç®—ç•¶å‰é€Ÿåº¦ä¸¦æ¢å¾©åˆ°æ­£å¸¸é€Ÿåº¦
            const currentSpeed = Math.sqrt(
              ball.speedX * ball.speedX + ball.speedY * ball.speedY
            );
            const normalSpeed = currentSpeed / boostMultiplier;

            // é‡æ–°è¨ˆç®—åå½ˆå¾Œçš„æ­£å¸¸é€Ÿåº¦
            ball.speedX = Math.sin(bounceAngle) * normalSpeed;
            ball.speedY = Math.cos(bounceAngle) * normalSpeed;

            ballBoosted = false;
            boostStatusElement.textContent = "ğŸ˜¤ é›»è…¦æ¥ä½äº†ä½ çš„åŠ é€Ÿçƒï¼";
            setTimeout(() => {
              if (
                boostStatusElement.textContent === "ğŸ˜¤ é›»è…¦æ¥ä½äº†ä½ çš„åŠ é€Ÿçƒï¼"
              ) {
                boostStatusElement.textContent = "";
              }
            }, 1000);
          } else if (ballBoosted && !boostByPlayer) {
            // å¦‚æœæ˜¯é›»è…¦åŠ é€Ÿçš„çƒï¼Œæ­£å¸¸åå½ˆä½†ä¿æŒåŠ é€Ÿç‹€æ…‹
            // çƒå·²ç¶“è¢«åŠ é€Ÿéäº†ï¼Œé€™æ¬¡ç¢°æ’ä¸æ”¹è®ŠåŠ é€Ÿç‹€æ…‹
          }
        }

        // å¾—åˆ†æª¢æ¸¬
        if (ball.y <= 0) {
          // ç©å®¶å¾—åˆ†ï¼Œé›»è…¦å¤±åˆ†
          playerScore++;
          playerScoreElement.textContent = playerScore;
          serverIsPlayer = false; // è¼¸çš„ä¸€æ–¹ï¼ˆé›»è…¦ï¼‰ç™¼çƒ
          pauseAfterScore();
          checkGameEnd();
        } else if (ball.y >= canvas.height) {
          // é›»è…¦å¾—åˆ†ï¼Œç©å®¶å¤±åˆ†
          computerScore++;
          computerScoreElement.textContent = computerScore;
          serverIsPlayer = true; // è¼¸çš„ä¸€æ–¹ï¼ˆç©å®¶ï¼‰ç™¼çƒ
          pauseAfterScore();
          checkGameEnd();
        }
      }

      // å¾—åˆ†å¾Œæš«åœéŠæˆ²
      function pauseAfterScore() {
        gamePaused = true;
        canStartNextRound = false;
        pauseStartTime = Date.now();

        // åœæ­¢çƒçš„ç§»å‹•
        ball.speedX = 0;
        ball.speedY = 0;

        // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
        updatePauseStatus();

        // 1ç§’å¾Œå…è¨±é–‹å§‹ä¸‹ä¸€å±€
        setTimeout(() => {
          if (gamePaused && gameRunning) {
            canStartNextRound = true;
            updatePauseStatus();
          }
        }, 1000);
      }

      // é–‹å§‹ä¸‹ä¸€å±€
      function startNextRound() {
        gamePaused = false;
        canStartNextRound = false;
        prepareNextServe();
      }

      // æ›´æ–°æš«åœç‹€æ…‹é¡¯ç¤º
      function updatePauseStatus() {
        if (gamePaused && gameRunning) {
          if (canStartNextRound) {
            servingStatusElement.textContent = "â¸ï¸ æŒ‰ç©ºç™½éµé–‹å§‹ä¸‹ä¸€å±€";
          } else {
            servingStatusElement.textContent =
              "â¸ï¸ éŠæˆ²æš«åœä¸­...ï¼ˆ1ç§’å¾Œå¯ç¹¼çºŒï¼‰";
          }
        }
      }

      // æº–å‚™ä¸‹ä¸€æ¬¡ç™¼çƒ
      function prepareNextServe() {
        waitingForServe = true;
        ballBoosted = false; // é‡ç½®åŠ é€Ÿç‹€æ…‹
        boostByPlayer = false; // é‡ç½®åŠ é€Ÿè€…è¨˜éŒ„
        computerTargetHitPoint = null; // é‡ç½®é›»è…¦æœŸæœ›æ“Šçƒé»
        computerInDefensePhase = false; // é‡ç½®é›»è…¦é˜²å®ˆéšæ®µ
        ball.speedX = 0;
        ball.speedY = 0;

        // é‡ç½®æ©«æ¡¿å‹•ç•«ç‹€æ…‹å’Œä½ç½®
        playerPaddleAnimating = false;
        computerPaddleAnimating = false;
        paddleAnimationProgress = 0;
        player.y = playerPaddleOriginalY;
        computer.y = computerPaddleOriginalY;

        // çƒæœƒåœ¨updateBallä¸­è·Ÿè‘—æ©«æ¡¿ç§»å‹•ï¼Œæ‰€ä»¥é€™è£¡ä¸éœ€è¦è¨­å®šä½ç½®
        updateServingStatus();
      }

      // æª¢æŸ¥éŠæˆ²çµæŸ
      function checkGameEnd() {
        if (playerScore >= 5) {
          gameRunning = false;
          gameStatusTitleElement.textContent = "ğŸ‰ æ­å–œï¼ä½ è´äº†ï¼";
          gameStatusElement.style.display = "flex";
          setDifficultyEnabled(true); // éŠæˆ²çµæŸæ™‚é‡æ–°å•Ÿç”¨é›£åº¦é¸æ“‡
        } else if (computerScore >= 5) {
          gameRunning = false;
          gameStatusTitleElement.textContent = "ğŸ˜” é›»è…¦è´äº†ï¼å†è©¦ä¸€æ¬¡å§ï¼";
          gameStatusElement.style.display = "flex";
          setDifficultyEnabled(true); // éŠæˆ²çµæŸæ™‚é‡æ–°å•Ÿç”¨é›£åº¦é¸æ“‡
        }
      }

      // é‡æ–°é–‹å§‹éŠæˆ²
      function restartGame() {
        gameRunning = true;
        gamePaused = false;
        canStartNextRound = false;
        playerScore = 0;
        computerScore = 0;
        playerScoreElement.textContent = "0";
        computerScoreElement.textContent = "0";
        gameStatusElement.style.display = "none";
        restartBtn.style.display = "none";
        boostStatusElement.textContent = "";
        setDifficultyEnabled(true); // é‡æ–°é–‹å§‹æ™‚å•Ÿç”¨é›£åº¦é¸æ“‡

        // é‡ç½®ä½ç½®
        player.x = canvas.width / 2 - 60;
        computer.x = canvas.width / 2 - 60;
        player.y = playerPaddleOriginalY;
        computer.y = computerPaddleOriginalY;

        // é‡ç½®å‹•ç•«ç‹€æ…‹
        playerPaddleAnimating = false;
        computerPaddleAnimating = false;
        paddleAnimationProgress = 0;

        // é‡æ–°é–‹å§‹æ™‚ç”±ç©å®¶ç™¼çƒ
        serverIsPlayer = true;
        ballBoosted = false;
        boostByPlayer = false;
        computerTargetHitPoint = null; // é‡ç½®é›»è…¦æœŸæœ›æ“Šçƒé»
        computerInDefensePhase = false; // é‡ç½®é›»è…¦é˜²å®ˆéšæ®µ
        boostParticles = []; // æ¸…é™¤ç²’å­æ•ˆæœ
        prepareNextServe();
      }

      // æ¸²æŸ“å‡½æ•¸ - èšåˆæ‰€æœ‰ç¹ªåœ–æ“ä½œ
      function render() {
        // æ¸…é™¤ç•«å¸ƒ
        ctx.fillStyle = "rgba(0, 0, 0, 0.5)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ç¹ªè£½éŠæˆ²å…ƒç´ 
        drawPaddle(player);
        drawPaddle(computer);
        drawBall();

        // ç¹ªè£½ç²’å­æ•ˆæœ
        updateAndDrawParticles();
      }

      // éŠæˆ²ä¸»å¾ªç’°
      function gameLoop(currentTime) {
        // è¨ˆç®—å¹€æ™‚é–“
        if (lastTime === 0) lastTime = currentTime;
        let frameTime = currentTime - lastTime;
        lastTime = currentTime;

        // é™åˆ¶æœ€å¤§å¹€æ™‚é–“ä»¥é˜²æ­¢èºæ—‹æ­»äº¡
        frameTime = Math.min(frameTime, MAX_FRAME_TIME);

        // ç´¯åŠ æ™‚é–“
        accumulator += frameTime;

        // å›ºå®šæ™‚é–“æ­¥é•·æ›´æ–°
        while (accumulator >= FIXED_TIMESTEP) {
          if (gameRunning && !gamePaused) {
            updatePlayer();
            updateComputer();
            updateBall();
          }
          // å‹•ç•«æ›´æ–°ï¼ˆç„¡è«–éŠæˆ²æ˜¯å¦æš«åœéƒ½è¦åŸ·è¡Œï¼‰
          updatePaddleAnimations();
          accumulator -= FIXED_TIMESTEP;
        }

        // æ¸²æŸ“ï¼ˆæ¯å¹€éƒ½æ¸²æŸ“ï¼Œä½†é‚è¼¯æ›´æ–°æ˜¯å›ºå®šé »ç‡ï¼‰
        render();

        // FPSè¨ˆç®—
        frameCount++;
        fpsTime += frameTime;
        if (fpsTime >= 1000) {
          currentFPS = Math.round((frameCount * 1000) / fpsTime);
          fpsCounterElement.textContent = `FPS: ${currentFPS}`;
          frameCount = 0;
          fpsTime = 0;
        }

        requestAnimationFrame(gameLoop);
      }

      // åˆå§‹åŒ–éŠæˆ²
      updateServingStatus();

      // é–‹å§‹éŠæˆ²
      requestAnimationFrame(gameLoop);
    </script>
  </body>
</html>
